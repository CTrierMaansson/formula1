---
title: |-
  F1 results
   \vspace{0.5in}
author:
- name: Christoffer Trier Månsson
output:
  BiocStyle::html_document:
    toc: yes
    toc_depth: 2
    number_sections: yes
    highlight: haddock
date: "`r format(Sys.time(), '%d %b %Y')`"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    tidy.opts = list(width.cutoff=100),
    tidy = FALSE,
    message = FALSE,
    collapse = TRUE,
    comment = "#>",
    root.dir = "C:/Users/Christoffer/OneDrive/1PhD/formula1/formula1/archive"
)
knitr::opts_knit$set(root.dir = "C:/Users/Christoffer/OneDrive/1PhD/formula1/formula1/archive")
```
\newpage
# Hvem fører vores bet
<img src="download.png" width="200" align="right">



## Seneste bets
```{r, echo=FALSE}
library(dplyr)
`%ni%` <- Negate(`%in%`)
bet_df <- function(Christoffer, Emil, Mikkel){
    drivers <- df_drivers_2022 <- read.csv("C:/Users/Christoffer/OneDrive/1PhD/formula1/formula1/archive/drivers.csv") %>% select(driverId, forename, surname)
    if(any(Christoffer %ni% drivers$surname)){
        stop("Én eller flere af Christoffers bud er ikke gyldige")
    }
    if(any(Emil %ni% drivers$surname)){
        stop("Én eller flere af Emils bud er ikke gyldige")
    }
    if(any(Mikkel %ni% drivers$surname)){
        stop("Én eller flere af Mikkels bud er ikke gyldige")
    }
    if(length(unique(Christoffer))!= 3){
        stop("Christoffer har ikke givet 3 forskellige bud")
    }
    if(length(unique(Emil))!= 3){
        stop("Emil har ikke givet 3 forskellige bud")
    }
    if(length(unique(Mikkel))!= 3){
        stop("Mikkel har ikke givet 3 forskellige bud")
    }
    df <- data.frame(Bets = c("Vinder", "Andenplads", "Tredjeplads"),
               Christoffer = Christoffer,
               Emil = Emil,
               Mikkel = Mikkel)
    return(df)
}

bet_df_w <- bet_df(Christoffer = c("Hamilton", "Leclerc", "Magnussen"),
                   Emil = c("Verstappen", "Hamilton", "Pérez"),
                   Mikkel = c("Sainz", "Hamilton", "Leclerc"))

```

Lav det så der vises hvilket løb dette er bets på

```{r, echo = F}

print(bet_df_w)
```


## Seneste top 10

## Seneste bet resultat
```{r, echo=FALSE}
point_calculator <- function(bet_df){
    df_race <- read.csv("C:/Users/Christoffer/OneDrive/1PhD/formula1/formula1/archive/races.csv") %>% filter(year == 2022) %>% filter(raceId == max(raceId))
    df_drivers <- read.csv("C:/Users/Christoffer/OneDrive/1PhD/formula1/formula1/archive/drivers.csv")
    df_results <- read.csv("C:/Users/Christoffer/OneDrive/1PhD/formula1/formula1/archive/results.csv") %>% filter(raceId == df_race$raceId) %>% 
        left_join(df_drivers, by = "driverId")
    #Christoffer
    bet_Christoffer <- bet_df %>% select(Christoffer)
    res_Christoffer <- match(bet_Christoffer$Christoffer, df_results$surname) 
    for(i in 1:length(res_Christoffer)){
        ddf <- df_results[res_Christoffer[i],]
        if(ddf$time == "\\N"){
            res_Christoffer[i] <- 20
        }
    }
    Christoffer_points <- sum(abs(res_Christoffer-c(1,2,3)))
    #Emil
    bet_Emil <- bet_df %>% select(Emil)
    res_Emil <- match(bet_Emil$Emil, df_results$surname) 
    for(i in 1:length(res_Emil)){
        ddf <- df_results[res_Emil[i],]
        if(ddf$time == "\\N"){
            res_Emil[i] <- 20
        }
    }
    Emil_points <- sum(abs(res_Emil-c(1,2,3)))
    #Mikkel
    bet_Mikkel <- bet_df %>% select(Mikkel)
    res_Mikkel <- match(bet_Mikkel$Mikkel, df_results$surname) 
    for(i in 1:length(res_Mikkel)){
        ddf <- df_results[res_Mikkel[i],]
        if(ddf$time == "\\N"){
            res_Mikkel[i] <- 20
        }
    }
    Mikkel_points <- sum(abs(res_Mikkel-c(1,2,3)))
    collected_points <- c(Christoffer_points,Emil_points,Mikkel_points)
    if(any(collected_points == 0)){
        if(sum(collected_points == 0) == 1){
            winner_all3 <- colnames(bet_df)[c(2,3,4)][collected_points == 0]
            
        }
    }
    else{
        winner_all3 <- NULL
    }
    collected_winners <- c(res_Christoffer[1]-1,res_Emil[1]-1,res_Mikkel[1]-1)
    if(is.null(winner_all3)){
        if(any(collected_winners == 0)){
            if(sum(collected_winners == 0) == 1){
                winner <- colnames(bet_df)[c(2,3,4)][collected_winners == 0]
            }
        }
        else{
            winner <- NULL
        }
    }
    
    res_df <- data.frame(Bets = "Point",
                         Christoffer = Christoffer_points,
                         Emil = Emil_points,
                         Mikkel = Mikkel_points)
    if(!is.null(winner_all3)){
        res_df[winner_all3] <- -30
    }
    if(!is.null(winner)){
        res_df[winner] <- -10
    }
    df <- rbind(bet_df,res_df)
    return(df)
}

```

Lav det så der vises hvilket løb dette er baseret på
```{r, echo = F}

print(point_calculator(bet_df_w))
```

## Løbende udvikling for bets

# Kørernes resultater

## Kørernes udvikling

## Teamets udvikling

## Fold difference from teammate


# Regler for spillet

Reglerne er simple. Hver fredag inden en løbsdag skal man have sendt til 
Christoffer i chatgruppen, **Formula1**, hvilke 3 kører man forventer bliver
nummer 1, 2 og 3 i det kommende løb.

**Alle hjælper alle med at huske at der skal indsendes bud på det kommende løb!**

Glemmer man at give noget bud får man 50 point i straf. 

Efter hvert løb bliver det beregnet hvor mange pladser ens kører er væk fra den
plads man gættede på, at køren blev. Hvis en kører udgår får man 
anses det at han slutter sidst og får position 20. 
Altså kan man minimalt få 0 point (før bonuser), mens 
man maximalt kan få 54 point (20-1 + 20-2 + 20-3 = 19+18+17 = 54).

Slutter ens bud bedre end man har budt får man stadig plus point

I formel1 sæsonen køres 23 løb. For at give lidt sikkerhed medregnes ens 3
dårligste bud ikke i regnskabet og derfor er hver spillers score baseret på
i alt 20 løb til slut i sæsonen.

## Bonus

Der udlådes bonus på to måder. 

1) Er man den eneste der har løbets vinder gives -10 point

2) Er man den eneste der har løbets top 3 gives -30 point

Har man kun eks. løbets nummer 1 og 2 gives -10 point.

Har man kun løbets nummer 2 og 3 gives ingen bonus. 

## Præmie

Det er blevet besluttet at vi alle skal en tur ud at køre gokart når sæsonen
er slut. Her skal nummer 2 og 3 i bettingspillet bestale for udgifter for
nummer 1. **Plus ham der slutter sidst giver en øl i fredagsbaren! ;)** 

# Resultaterne for 2022 sæsonen

Her finder man et lille overblik over hvordan 2022 sæsonen gik. 

## Slut resultat

```{r, echo=FALSE}
library(dplyr)

df_races_2022 <- read.csv("C:/Users/Christoffer/OneDrive/1PhD/formula1/formula1/archive/races.csv") %>% filter(year == 2022)
df_drivers_2022 <- read.csv("C:/Users/Christoffer/OneDrive/1PhD/formula1/formula1/archive/drivers.csv") %>% select(driverId, forename, surname)
df_results_2022 <- read.csv("C:/Users/Christoffer/OneDrive/1PhD/formula1/formula1/archive/results.csv") %>% filter(raceId %in% df_races_2022$raceId) %>% 
    group_by(driverId) %>% 
    summarise(.groups = "keep",
              cumulativePoints = cumsum(points),
              raceId = raceId,
              totPoints = sum(points))
totResult <- abs(sort(-unique(df_results_2022$totPoints)))
df_results_2022 <- df_results_2022 %>%  
    left_join(df_drivers_2022, by = "driverId") %>% 
    left_join(df_races_2022 %>% select(raceId,name,date), by = "raceId") %>% 
    mutate(driverName = paste(forename, surname)) %>% 
    mutate(isTop10 = ifelse(totPoints %in% totResult[1:10] | surname == "Magnussen","Yes","No")) %>% 
    filter(isTop10 == "Yes") %>% 
    mutate(place = factor(name, level = unique(name))) %>% 
    mutate(label = ifelse(raceId == max(raceId), 
                          ifelse(isTop10 == "Yes", as.character(surname),NA_character_),
                          NA_character_))

```

Sidste års klare vinder var Max Verstappen, men det var meget tæt mellem nummer
2 og 3. 

```{r, echo=FALSE}
library(ggplot2)
library(viridis)
library(ggrepel)
res <- df_results_2022 %>% filter(raceId == 1074) %>%
    arrange(totPoints)
res <- res %>% mutate(driverName = factor(driverName, levels = res$driverName))
ggplot(res, aes(x = driverName,
           y = totPoints,
           fill = driverName))+
    scale_fill_viridis("magma",discrete = T)+ 
    geom_bar(stat = "identity")+
    theme_minimal()+
    labs(x = "",
         y = "Accumulated points",
         title = "2022")+ 
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, 
                                     size = 8, face = "bold"),
          legend.background = element_rect(),
    plot.title = element_text(angle = 0, size = 16, face = 'bold', vjust = 1),
    plot.caption = element_text(angle = 0, size = 10, vjust = 1, hjust = 0.37),
    axis.text.y = element_text(angle = 0, size = 12),
    axis.title = element_text(size = 14, face = 'bold'),
    axis.title.x = element_text(size = 14, face = 'bold'),
    axis.title.y = element_text(size = 14, face = 'bold'),
    legend.text = element_text(size = 12), 
    title = element_text(size = 14, face = "bold"),
    panel.grid.major.x = element_blank())+
    guides(fill="none")

```

## Udviklingen gennem 2022

Verstappen havde en dårligere start på sæsonen end nogen af hans konkurrenter
Herimod havde Magnussen en meget stille sidste halvdel af sæsonen. 
```{r, echo=FALSE,fig.height= 6}
library(ggplot2)
library(viridis)
library(ggrepel)
ggplot(df_results_2022, aes(x = place,
                            y = cumulativePoints,
                            colour = driverName,
                            group = driverName))+
    geom_point()+
    scale_color_viridis("magma",discrete = T)+ 
    geom_line()+
    theme_minimal()+
    labs(y = "Points",
         x = "",
         title = "2022")+
    geom_label_repel(aes(label=label),
                  nudge_x = 2,
                  na.rm = TRUE,
                  label.size = NA,
                  size = 3.5,
                  fill = alpha(c("white"),0),
                  parse = F,
                 max.overlaps = 100)+
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1,size = 8),
          legend.background = element_rect(),
    plot.title = element_text(angle = 0, size = 16, face = 'bold', vjust = 1),
    plot.caption = element_text(angle = 0, size = 10, vjust = 1, hjust = 0.37),
    axis.text.y = element_text(angle = 0, size = 12),
    axis.title = element_text(size = 14, face = 'bold'),
    axis.title.x = element_text(size = 14, face = 'bold'),
    axis.title.y = element_text(size = 14, face = 'bold'),
    legend.text = element_text(size = 12), 
    title = element_text(size = 14, face = "bold"))+
   guides(color="none")
```

## Team ranking i 2022

Red Bull med Perez (samlet nummer 3) og Verstappen (samlet vinder) blev en 
rimelig klar vinder af team konkurrencen. Kampen om andepladsen var tæt mellem
Mercedes (Russell (4) og Hamilton (5)) og Ferrari (Leclerc (2) og Sainz (6)).
Williams slutter sidst med bare 7 point på en hel sæson! Det er sgu en ommer!

```{r, echo=FALSE,fig.height= 6}
library(dplyr)
library(scales)
df_constructors <- read.csv("C:/Users/Christoffer/OneDrive/1PhD/formula1/formula1/archive/constructors.csv") %>% select(constructorId, name)
df_results_2022_teams <- read.csv("C:/Users/Christoffer/OneDrive/1PhD/formula1/formula1/archive/results.csv") %>% filter(raceId %in% df_races_2022$raceId) %>% 
    group_by(constructorId) %>% 
    summarise(.groups = "keep",
              raceId = raceId,
              totPoints = sum(points)) %>% 
        left_join(df_constructors, by = "constructorId") %>% 
    filter(raceId == "1095") %>% 
    arrange(totPoints) %>% 
    distinct()
df_results_2022_teams %>% 
    mutate(name = factor(name, levels = unique(df_results_2022_teams$name))) %>% 
    ggplot(aes(x = name, y = totPoints,
           fill = name)) +
    scale_fill_viridis("magma",discrete = T)+ 
    geom_bar(stat = "identity")+
    theme_minimal()+
    scale_y_continuous(trans = "log10",
                       labels = label_comma())+
    labs(x = "",
         y = "Accumulated points",
         title = "2022")+ 
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, 
                                     size = 8, face = "bold"),
          legend.background = element_rect(),
    plot.title = element_text(angle = 0, size = 16, face = 'bold', vjust = 1),
    plot.caption = element_text(angle = 0, size = 10, vjust = 1, hjust = 0.37),
    axis.text.y = element_text(angle = 0, size = 12),
    axis.title = element_text(size = 14, face = 'bold'),
    axis.title.x = element_text(size = 14, face = 'bold'),
    axis.title.y = element_text(size = 14, face = 'bold'),
    legend.text = element_text(size = 12), 
    title = element_text(size = 14, face = "bold"),
    panel.grid.major.x = element_blank())+
    guides(fill="none")


```

# Information om data

Data er taget fra følgende side <https://www.kaggle.com/datasets/rohanrao/formula-1-world-championship-1950-2020?resource=download> som løbende opdatere den seneste data fra hele F1

Koden til dette dokument er frit tilgængelig gennem <https://github.com/CTrierMaansson/formula1> hvor der også vil komme løbende
opdateringer. Jeg henviser til **issues** fanen for bugs og andre problemer 
med dokumente. Her kan man også rette forslag til statistik man ønsker skal være
en del af dokumentet 

